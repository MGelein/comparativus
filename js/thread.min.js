var K=4;var startChar="⁑";var endChar="‡";self.onmessage=function(a){var b=a.data.action;var c=a.data.params;switch(b){case"buildDictionary":buildDictionary(c.textName,c.text);break;case"decorateText":decorateText(c.textName,c.text,c.match,c.edits);break;case"prepareText":prepareText(c.textName,c.text,c.config);break}};function prepareText(d,f,c){console.log("preparing text for use: "+d);var b=[];var a;var e;if(c.stripWhiteSpace){e=[" ","\t","\n","\r"];a=removeAndKeepTrack(f,b,e);b=a.edits;f=a.text}if(c.stripPunctuation){e=["。","』","」","，","《","》","：","『","？","「","；",",",".","!","?"];a=removeAndKeepTrack(f,b,e);b=a.edits;f=a.text}message("PrepareDone",{textName:d,text:f,edits:b})}function removeAndKeepTrack(f,b,d){var g=d.length;var e;var c;var a;for(c=0;c<g;c++){a=removeAndKeepTrackOfChar(f,b,d[c]);f=a.text;b=a.edits}return{text:f,edits:b}}function removeAndKeepTrackOfChar(b,a,d){while(b.indexOf(d)!=-1){a.push({index:b.indexOf(d),character:d});b=b.replace(d,"")}return{text:b,edits:a}}function insertAt(c,a,b){return c.slice(0,a)+b+c.slice(a)}function decorateText(a,k,g,h){console.log("Starting text decoration of "+a);var j=g.length;var c;var l=(a=="a");var f=0;for(var e=0;e<j;e++){c=g[e];if(l){k=insertAt(k,c.indexA+f,startChar);f++}else{k=insertAt(k,c.indexB+f,startChar);f++}}var d=k.split(startChar);d=undoEdit(d,h);k=d.join(startChar);var b=0;while(k.indexOf(startChar)!=-1){k=k.replace(startChar,"<span id='match-"+b+a+"' class='matchSpan' onmouseover='onMatchMouseOver(this)' onmouseout='onMatchMouseOut(this)'>"+b+"</span>");b++}message("DecorateDone",{textName:a,result:k})}function undoEdit(f,b){var d;var c=0;var e=0;var a;while(b.length!=0){d=b.pop();e=0;while(d.index>0){a=f[e];e++;d.index-=a.length}d.index+=a.length;e--;f[e]=insertAt(a,d.index,d.character)}return f}function buildDictionary(c,e){var d=0;var f={};var a=e.length-K;var b="";for(d=0;d<a;d++){b=e.substr(d,K);if(b in f){f[b].push(d)}else{f[b]=[d]}}message("DictDone",{textName:c,dictionary:f})}function message(b,a){postMessage({action:b,params:a})};