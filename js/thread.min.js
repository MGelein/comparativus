var K=4;self.onmessage=function(a){var b=a.data.action;var c=a.data.params;switch(b){case"buildDictionary":buildDictionary(c.textName,c.text);break;case"decorateText":decorateText(c.textName,c.text,c.match,c.edits);break;case"prepareText":prepareText(c.textName,c.text,c.config);break}};function prepareText(d,f,c){console.log("preparing text for use: "+d);var b=[];var a;var e;if(c.stripWhiteSpace){e=[" ","\t","\n","\r"];a=removeAndKeepTrack(f,b,e);b=a.edits;f=a.text}if(c.stripPunctuation){e=["。","』","」","，","《","》","：","『","？","「","；"];a=removeAndKeepTrack(f,b,e);b=a.edits;f=a.text}message("PrepareDone",{textName:d,text:f,edits:b})}function removeAndKeepTrack(f,b,d){var g=d.length;var e;var c;var a;for(c=0;c<g;c++){a=removeAndKeepTrackOfChar(f,b,d[c]);f=a.text;b=a.edits}return{text:f,edits:b}}function removeAndKeepTrackOfChar(b,a,d){while(b.indexOf(d)!=-1){a.push({index:b.indexOf(d),character:d});b=b.replace(d,"")}return{text:b,edits:a}}function decorateText(a,o,g,j){var d=[];var k=g.length;var c;var p=(a=="a");var l=0;var f=0;var h=0;if(p){g.sort(function(m,i){i.indexA-m.indexA})}else{g.sort(function(m,i){i.indexB-m.indexB})}for(var e=0;e<k;e++){c=g[e];if(p){l=c.indexA}else{l=c.indexB}f=l+c.l;d.push(o.substring(h,l));d.push(o.substring(l,f));h=f}k=d.length;d.push(o.substring(h,o.length-1));d=undoEdit(d,j);var b=0;var n=[];for(var e=0;e<k;e+=2){n.push(d[e]+"<span id='match-"+b+a+"' class='matchSpan' onmouseover='onMatchMouseOver(this)' onmouseout='onMatchMouseOut(this)'>");b++;n.push(d[e+1]+"</span>")}message("DecorateDone",{textName:a,result:n.join()})}function undoEdit(g,b){var d;var c=0;var e=0;var f=0;var a;while(b.length!=0){d=b.pop();c=0;e=0;while(e<=g.length&&c+g[e].length<d.index){c+=g[e].length;e++}if(e>0){e--}f=d.index-c;console.log("i: "+e+"\ncedit.charac: "+d.character+"\niOffset: "+f);a=g[e];g[e]=a.substring(0,f)+d.character+a.substring(f,a.length)}return g}function buildDictionary(c,e){var d=0;var f={};var a=e.length-K;var b="";for(d=0;d<a;d++){b=e.substr(d,K);if(b in f){f[b].push(d)}else{f[b]=[d]}}message("DictDone",{textName:c,dictionary:f})}function message(b,a){postMessage({action:b,params:a})};