var thread;var texts={};var dicts={};var edits={};var matches=[];var minMatchLength=10;var RUNNING=0;$(document).ready(function(){thread=new Worker("js/thread.js?v=10");thread.onmessage=function(a){var b=a.data.action;var c=a.data.params;switch(b){case"DictDone":dicts.toBuild--;dicts[c.textName]=c.dictionary;if(dicts.toBuild==0){console.log("Starting Comparison");startComparison()}break;case"DecorateDone":texts.toDecorate--;setFilePanelContent(c.textName,c.result);setComparisonButtonText("Creating Text Decoration ("+texts.toDecorate+" left)");if(texts.toDecorate==0){setComparisonButtonText("(Re)Compare Texts");showLoadingAnimation(false);RUNNING=0}break;case"PrepareDone":texts[c.textName]=c.text;edits[c.textName]=c.edits;$("#info"+name.toUpperCase()).html("Length: "+texts[c.textName].length+" characters");$("#text"+name.toUpperCase()).html(c.text);setComparisonButtonText("Building dictionaries...");buildDictionary(c.textName);break}};addUIListeners()});function addUIListeners(){$("#comparisonButton").click(function(){console.log("Asked to start");if(RUNNING>0){return}var b=($("#textA").html()=="");var a=($("#textB").html()=="");if(b){shakeFileInput("a")}if(a){shakeFileInput("b")}if(b||a){return}dicts.toBuild=2;RUNNING=1;setComparisonButtonText("Preparing texts for comparison...");showLoadingAnimation(true);loadDataFile("a",$("#textA").html());loadDataFile("b",$("#textB").html())})}function startComparison(){setComparisonButtonText("Running Comparison");minMatchLength=getMinMatchSize();matches=[];var a=dicts.a;var h=dicts.b;var c=Object.keys(a);var g=c.length;var b=[];var e=0;var f=0;for(var d=0;d<g;d++){f+=a[c[d]].length;if(c[d] in h){e+=a[c[d]].length+h[c[d]].length;b.push(c[d]);expandMatches(a[c[d]],h[c[d]])}}c=Object.keys(h);g=c.length;for(var d=0;d<g;d++){f+=h[c[d]].length}console.log("Total seed Amt: "+f+" and overlap seed Amt: "+e+" > Similarity Score: "+e/f);setSimilarityScore(e/f);showResultTable(matches);texts.toDecorate=2;setComparisonButtonText("Creating Text Decoration ("+texts.toDecorate+" left)");decorateText("a",matches,edits.a);decorateText("b",matches,edits.b)}function expandMatches(g,e){var h=g.length;var f=e.length;var c;var a;for(var d=0;d<h;d++){c=g[d];for(var b=0;b<f;b++){a=e[b];expandMatch(c,a)}}}function expandMatch(f,e){var h=matches.length;var g;for(var d=0;d<h;d++){g=matches[d];if((f<g.indexA+g.l)&&(f>g.indexA)){if((e<g.indexB+g.l)&&(e>g.indexB)){return}}}var c=10;var b=texts.a.substr(f,c);var a=texts.b.substr(e,c);var j=0;while(levDistRatio(b,a)<0.8){c--;b=texts.a.substr(f,c);a=texts.b.substr(e,c)}while(j<3){if(levDistRatio(b,a)<0.8){j++}else{j=0}c++;b=texts.a.substr(f,c);a=texts.b.substr(e,c)}c-=3;j=0;b=texts.a.substr(f,c);a=texts.b.substr(e,c);while(j<3){if(levDistRatio(b,a)<0.8){j++}else{j=0}c++;f--;e--;b=texts.a.substr(f,c);a=texts.b.substr(e,c)}f+=3;e+=3;c-=3;b=texts.a.substr(f,c);a=texts.b.substr(e,c);if(c>=minMatchLength){matches.push({l:c,indexA:f,indexB:e,textA:b,textB:a,r:levDistRatio(b,a)})}}function levDistRatio(g,e){var b=g.length;var f=e.length;var a=[];for(var d=0;d<=f;d++){a[d]=[d]}for(var c=0;c<=b;c++){a[0][c]=c}for(d=1;d<=f;d++){for(c=1;c<=b;c++){if(g.charAt(d-1)==e.charAt(c-1)){a[d][c]=a[d-1][c-1]}else{a[d][c]=Math.min(a[d-1][c-1]+1,Math.min(a[d][c-1]+1,a[d-1][c]+1))}}}return 1-(a[f][b]/b)}function message(b,a){thread.postMessage({action:b,params:a})}function loadDataFile(b,c){console.log("Loading Data file: "+b);var a={stripWhiteSpace:$("#stripWhiteSpace").val(),stripPunctuation:$("#stripPunctuation").val()};message("prepareText",{textName:b,text:c,config:a})}function buildDictionary(a){console.log("Message to start Building Dict for: "+a);message("buildDictionary",{textName:a,text:texts[a]})}function decorateText(b,c,a){message("decorateText",{textName:b,text:texts[b],match:c,edits:a})};