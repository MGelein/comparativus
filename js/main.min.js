var thread;var texts={};var dicts={};var edits={};var matches=[];var minMatchLength=10;var RUNNING=0;$(document).ready(function(){thread=new Worker("js/thread.js?v=11");thread.onmessage=function(a){var b=a.data.action;var c=a.data.params;switch(b){case"DictDone":dicts.toBuild--;dicts[c.textName]=c.dictionary;if(dicts.toBuild==0){console.log("Starting Comparison");startComparison()}break;case"DecorateDone":texts.toDecorate--;setFilePanelContent(c.textName,c.result);setComparisonButtonText("Creating Text Decoration ("+texts.toDecorate+" left)");if(texts.toDecorate==0){setComparisonButtonText("(Re)Compare Texts");showLoadingAnimation(false);RUNNING=0}break;case"PrepareDone":texts[c.textName]=c.text;edits[c.textName]=c.edits;$("#info"+name.toUpperCase()).html("Length: "+texts[c.textName].length+" characters");$("#text"+name.toUpperCase()).html(c.text);setComparisonButtonText("Building dictionaries...");buildDictionary(c.textName);break}};addUIListeners()});function addUIListeners(){$("#comparisonButton").click(function(){console.log("Asked to start");if(RUNNING>0){return}var b=($("#textA").html()=="");var a=($("#textB").html()=="");if(b){shakeFileInput("a")}if(a){shakeFileInput("b")}if(b||a){return}dicts.toBuild=2;RUNNING=1;setComparisonButtonText("Preparing texts for comparison...");showLoadingAnimation(true);loadDataFile("a",$("#textA").text());loadDataFile("b",$("#textB").text())})}function startComparison(){setComparisonButtonText("Running Comparison");minMatchLength=getMinMatchSize();matches=[];var a=dicts.a;var h=dicts.b;var c=Object.keys(a);var g=c.length;var b=[];var e=0;var f=0;for(var d=0;d<g;d++){f+=a[c[d]].length;if(c[d] in h){e+=a[c[d]].length+h[c[d]].length;b.push(c[d]);expandMatches(a[c[d]],h[c[d]])}}c=Object.keys(h);g=c.length;for(var d=0;d<g;d++){f+=h[c[d]].length}console.log("Total seed Amt: "+f+" and overlap seed Amt: "+e+" > Similarity Score: "+e/f);setSimilarityScore(e/f);showResultTable(matches);texts.toDecorate=2;setComparisonButtonText("Creating Text Decoration ("+texts.toDecorate+" left)");decorateText("a",matches,edits.a);decorateText("b",matches,edits.b)}function expandMatches(g,e){var h=g.length;var f=e.length;var c;var a;for(var d=0;d<h;d++){c=g[d];for(var b=0;b<f;b++){a=e[b];expandMatch(c,a)}}}function expandMatch(g,f){var j=matches.length;var h;for(var e=0;e<j;e++){h=matches[e];if((g<h.indexA+h.l)&&(g>h.indexA)){if((f<h.indexB+h.l)&&(f>h.indexB)){return}}}var d=10;var b=texts.a.substr(g,d);var a=texts.b.substr(f,d);var k=0;while(levDistRatio(b,a)<0.8&&d>0){d--;b=texts.a.substr(g,d);a=texts.b.substr(f,d)}while(k<3){if(levDistRatio(b,a)<0.8){k++}else{k=0}d++;b=texts.a.substr(g,d);a=texts.b.substr(f,d);if(g+d>texts.a.length||f+d>texts.b.length){break}}d-=3;k=0;b=texts.a.substr(g,d);a=texts.b.substr(f,d);while(k<3){if(levDistRatio(b,a)<0.8){k++}else{k=0}d++;g--;f--;if(g<0||f<0){g=f=0;break}b=texts.a.substr(g,d);a=texts.b.substr(f,d)}g+=k;f+=k;d-=k;b=texts.a.substr(g,d);a=texts.b.substr(f,d);if(d>=minMatchLength){var c={l:d,indexA:g,indexB:f,textA:b,textB:a,r:levDistRatio(b,a)};matches.push(c)}}function levDistRatio(g,e){var b=g.length;var f=e.length;var a=[];for(var d=0;d<=f;d++){a[d]=[d]}for(var c=0;c<=b;c++){a[0][c]=c}for(d=1;d<=f;d++){for(c=1;c<=b;c++){if(g.charAt(d-1)==e.charAt(c-1)){a[d][c]=a[d-1][c-1]}else{a[d][c]=Math.min(a[d-1][c-1]+1,Math.min(a[d][c-1]+1,a[d-1][c]+1))}}}return 1-(a[f][b]/b)}function message(b,a){thread.postMessage({action:b,params:a})}function loadDataFile(b,c){console.log("Loading Data file: "+b);var a={stripWhiteSpace:$("#stripWhiteSpace").val(),stripPunctuation:$("#stripPunctuation").val()};message("prepareText",{textName:b,text:c,config:a})}function buildDictionary(a){console.log("Message to start Building Dict for: "+a);message("buildDictionary",{textName:a,text:texts[a]})}function decorateText(b,c,a){message("decorateText",{textName:b,text:texts[b],match:c,edits:a})};